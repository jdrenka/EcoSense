<!DOCTYPE html>
<html>
<head>
    <title>IOT Dashboard</title>
    <link rel='stylesheet' href='/styles.css'>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class='navbar'>
        <h1 class='text'>Sensor Dashboard</h1>
    </div>

    <h1 class='text'>Greenhouse Sensor (GH4124):</h1>
    <div class='sensordisplay'>
        <div class='currentReadingsPanel'>
            <div class='topsection'>
                <div class='headerwithcountdown'>
                    <h1 id='currentsensordisplay'>Current Sensor Data</h1>
                    <span id='statusicon'><img id = statusicon src="images/bolt.png" alt="Active"></span>
                </div>
                <div class='timeandbolt'>
                    <p id='timecontainer'>Last reading: <span id="time">--</span></p>
                    <span id="countdown">10</span> 
                </div>
            </div>
            
            <div class='bodysection'>
                <p>Temperature: <span id="temperature">--</span>Â°C</p>
                <p>Humidity: <span id="humidity">--</span>%</p>
                <div id="displayVariable">Total Readings: <span id="variableValue">--</span></div>
                <button id="switchChartType">Switch to Bar Chart</button>
                <button id="pauseButton">Pause</button>
                <button id="toggleDailyReport">Toggle Daily Report</button>
            </div>
        </div>
        <canvas id="sensorChart" width="800" height="400"></canvas>
    </div>

    <div class='dailyReportSection'>
        <div id="dailyReportContainer" style="display: none;">
            <canvas id="dailyReportChart"></canvas>
        </div>
    </div>

    <script>
        const UPDATE_TIME = 5; // seconds
        let sensorData = { timestamps: [], temperatures: [], humidities: [] };
        let currentChartType = 'line';
        let chart;
        let dailyReportChart;
        let maxDataPoints = 100;
        let isPaused = false;
        let totalReadings = 0;

        document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('sensorChart').getContext('2d');
            const dailyReportChartCtx = document.getElementById('dailyReportChart').getContext('2d');
            initCharts(ctx, dailyReportChartCtx);
            setupEventListeners();
            startCountdown();
        });

        function initCharts(ctx, dailyReportChartCtx) {
            chart = new Chart(ctx, {
                type: currentChartType,
                data: getChartData(),
                options: getChartOptions()
            });
            dailyReportChart = new Chart(dailyReportChartCtx, {
                type: 'line',
                data: getChartData(),
                options: getChartOptions()
            });
        }

        function getChartData() {
            return {
                labels: sensorData.timestamps,
                datasets: [{
                    label: 'Temperature (Â°C)',
                    data: sensorData.temperatures,
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: currentChartType === 'bar' ? 'rgb(255, 99, 132)' : 'rgba(255, 99, 132, 0.5)',
                    fill: false
                }, {
                    label: 'Humidity (%)',
                    data: sensorData.humidities,
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: currentChartType === 'bar' ? 'rgb(54, 162, 235)' : 'rgba(54, 162, 235, 0.5)',
                    fill: false
                }]
            };
        }

        function getChartOptions() {
    return {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: {
                ticks: {
                    color: 'white',
                    font: {
                        weight: 'bold'
                    }
                },
                title: {
                    display: false,
                    text: 'Time',
                    color: 'white',
                    font: {
                        weight: 'bold',
                        size: 16
                    }
                }
            },
            y: {
                ticks: {
                    color: 'white',
                    font: {
                        weight: 'bold'
                    }
                },
                title: {
                    display: false,
                    text: 'Value',
                    color: 'white',
                    font: {
                        size: 50
                    }
                }
            }
        },
        plugins: {
            legend: {
                labels: {
                    color: 'white',
                    weight: 'bold',
                    font: {
                        weight: 'bold',
                        size: 15
                    }
                }
            }
        }
    };
}

        function setupEventListeners() {
            const toggleButton = document.getElementById('toggleDailyReport');
            const dailyReportContainer = document.getElementById('dailyReportContainer');
            toggleButton.addEventListener('click', function() {
                if (dailyReportContainer.style.display === 'none') {
                    dailyReportContainer.style.display = 'block';
                    toggleButton.textContent = 'Hide Daily Report';
                    fetchDailyDataAndUpdateChart();
                } else {
                    dailyReportContainer.style.display = 'none';
                    toggleButton.textContent = 'Show Daily Report';
                }
            });

            const pauseButton = document.getElementById('pauseButton');
            pauseButton.addEventListener('click', function() {
                isPaused = !isPaused;
                if (isPaused) {
                    clearInterval(interval);
                    pauseButton.textContent = "Restart Sensor";
                    document.getElementById('statusicon').innerHTML = 'ðŸ’¤';
                } else {
                    pauseButton.textContent = "Pause";
                    document.getElementById('statusicon').innerHTML = '<img id = "statusicon" src="images/bolt.png" alt="Active">';
                    startCountdown();
                }
            });

            const switchChartTypeButton = document.getElementById('switchChartType');
            switchChartTypeButton.addEventListener('click', function() {
                currentChartType = (currentChartType === 'line') ? 'bar' : 'line';
                chart.destroy();
                initCharts(document.getElementById('sensorChart').getContext('2d'), document.getElementById('dailyReportChart').getContext('2d'));
                switchChartTypeButton.textContent = `Switch to ${currentChartType === 'line' ? 'Bar' : 'Line'} Chart`;
            });
        }

        function fetchDailyDataAndUpdateChart() {
            fetch('/daily-report')
                .then(response => response.json())
                .then(data => {
                    dailyReportChart.data.labels = data.map(entry => new Date(entry.timestamp).toLocaleTimeString());
                    dailyReportChart.data.datasets[0].data = data.map(entry => entry.temperature);
                    dailyReportChart.data.datasets[1].data = data.map(entry => entry.humidity);
                    dailyReportChart.update();
                })
                .catch(error => console.error('Failed to fetch daily report data:', error));
        }

        function startCountdown() {
            let counter = UPDATE_TIME;
            const countdownElement = document.getElementById('countdown');
            countdownElement.textContent = `(${counter})`;
            interval = setInterval(() => {
                if (--counter <= 0) {
                    fetchData();
                    counter = UPDATE_TIME;
                }
                countdownElement.textContent = `(${counter})`;
            }, 1000);
        }
        function formatDate(timestamp) {
    // Example timestamp: "2024-04-08T23:25:00Z"
    let date = new Date(timestamp);
    let month = (date.getMonth() + 1).toString().padStart(2, '0');  // Get month and pad with zero if necessary
    let day = date.getDate().toString().padStart(2, '0');           // Get day and pad with zero if necessary
    let hour = date.getHours();
    let minute = date.getMinutes().toString().padStart(2, '0');     // Pad minute with zero
    let ampm = hour >= 12 ? 'PM' : 'AM';                            // Determine AM/PM

    hour = hour % 12;
    hour = hour ? hour : 12; // Convert 0 hour to 12 for 12-hour format

    // Build the custom formatted date string
    return `${month}-${day} ${hour}:${minute} ${ampm}`;
}

        function fetchData() {
            if (!isPaused) {
                fetch('/recentData')
                    .then(response => response.json())
                    .then(data => {
                        const formattedTime = new Date(data.timestamp).toLocaleTimeString();
                        data.timestamp = formatDate(data.timestamp);                   
                        chart.data.labels.push(data.timestamp);
                        chart.data.datasets[0].data.push(data.temperature);
                        chart.data.datasets[1].data.push(data.humidity);
                        chart.update();

                        document.getElementById('temperature').textContent = `${data.temperature}Â°C`;
                        document.getElementById('humidity').textContent = `${data.humidity}%`;
                        document.getElementById('time').textContent = formattedTime;
                        document.getElementById('variableValue').textContent = ++totalReadings;
                    })
                    .catch(error => {
                        console.error('Error fetching data:', error);
                        document.getElementById('countdown').textContent = 'Paused';
                        clearInterval(interval);
                    });
            }
        }
    </script>
</body>
</html>
