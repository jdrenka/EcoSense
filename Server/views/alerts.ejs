<!DOCTYPE html>

<html>

<head>
<title>InsightDash</title>
<link rel='stylesheet' href='/styles.css'>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> 
<style>
    .swal2-popup {
        background-color: #333 !important;
        color: white !important;
    }
    .swal2-input {
        background-color: #555 !important;
        color: white !important;
        border: none !important;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
        font-weight: 500 !important;
    }
    .swal2-input::placeholder {
        color: #aaa !important;
        font-size: 0.8em !important;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
        font-weight: 500 !important;
    }
    .swal2-select {
        background-color: #555 !important;
        color: white !important;
        border: none !important;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
        font-weight: 500 !important;
    }
    .swal2-select::placeholder {
        color: #aaa !important;
        font-size: 1em !important;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
        font-weight: 500 !important;
    }
    .button-select {
        margin: 5px;
        padding: 10px 20px;
        background-color: #555;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    .button-select.selected {
        background-color: green;
    }
</style>
</head>

<body>
    <% function truncateMessage(message, maxLength) { %>
        <% if (message.length > maxLength) { %>
            <%= message.substring(0, maxLength) + '...' %>
        <% } else { %>
            <%= message %>
        <% } %>
    <% } %>

    <div class='navbar'>
        
        <a class = 'smallatag' href = '/sensorview'>
            <img href = 'sensorDash.ejs' src='images/logo.png' id='logopic'>
        </a>
        <button id = 'sensorviewbutton' class = 'navbuttons'>View Sensors</a>
        <button id='createthreshold_button' class = 'navbuttons'>Manage Alerts</button>
        <button id = 'helpbutton' class = 'navbuttons'>Help</button>
        <button id = 'logoutbutton' class = 'navbuttons'>Logout</button>
    </div>

    <div class='alertheader'>
        <h1 class='text' id='sensorlistmessage'>Your Alerts:</h1>
        <button id='createAlertButton' class='navbuttons'>Create New Alert</button>
    </div>
    <div class = 'innerlistview'>
        <% alerts.forEach(function(alert) { %>
            <div class='listAlertRows' data-alert-id="<%= alert.alert_id %>">
                <h1 class='alertRowEntryData' id = 'alerticon'>üì¢</h1>
                <h1 class='alertRowEntryData' id = 'firstalertentry'><%= alert.sensor_name %></h1>
                <h1 class='alertRowEntryData'><%=alert.alertName.charAt(0).toUpperCase() + alert.alertName.slice(1)%></h1>
                <h1 class='alertRowEntryData' id = 'conditionalertentry'>
                    <%= alert.data_type.charAt(0).toUpperCase() + alert.data_type.slice(1) %> 
                    <%= alert.alertCondition === 'less_than' ? '<' : '>' %> 
                    <%= alert.threshold_value %>
                </h1>
                <h1 class='alertRowEntryData'><%= alert.phone_number %></h1>
                <h1 class='alertRowEntryData' id = 'messagerow'><%= truncateMessage(alert.alertMessage, 30) %></h1>
                <img src='images/deleteBin.png' class='deleteIcon' alt='Delete Alert' id = 'deleteAlert'>
            </div>
        <% }); %>

            <div class= 'whiteline'></div>
           


    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {


        const logoutButton = document.getElementById('logoutbutton');
        const sensorViewButton = document.getElementById('sensorviewbutton');
        const alertViewButton = document.getElementById('createthreshold_button');
        const createAlertButton = document.getElementById('createAlertButton');
        logoutButton.addEventListener('click', function() {
            window.location.href = '/logout';
        });

        alertViewButton.addEventListener('click', function() {
            window.location.href = '/alertView';
        });

        sensorViewButton.addEventListener('click', function() {
             window.location.href = '/sensorview';
        });

        document.querySelectorAll('.deleteIcon').forEach(function(deleteIcon) {
            deleteIcon.addEventListener('click', function() {
                const alertRow = this.closest('.listAlertRows');
                const alertId = alertRow.getAttribute('data-alert-id');
                console.log('Alert ID:', alertId); 

                Swal.fire({
                    title: 'Are you sure?',
                    text: 'Do you want to delete this alert?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, delete it!',
                    cancelButtonText: 'No, keep it'
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch(`/delete-alert/${alertId}`, {
                            method: 'DELETE'
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                Swal.fire('Deleted!', 'Your alert has been deleted.', 'success')
                                .then(() => {
                                    location.reload();
                                });
                            } else {
                                Swal.fire('Error!', 'There was a problem deleting your alert.', 'error');
                            }
                        });
                    }
                });
            });
        });

        createAlertButton.addEventListener('click', async function() {
      // Fetch the list of sensors
      const response = await fetch('/sensors');
      const sensors = await response.json();

      // Build the sensor options HTML
      const sensorOptions = sensors.map(sensor => `<option value="${sensor.sensor_id}">${sensor.sensor_name}</option>`).join('');

      let selectedDataType = '';
      let selectedCondition = '';

      Swal.fire({
        title: 'Create New Alert',
        html: `
          <div class = 'createalertsection' id = 'sensor_select'>
            <select id="sensorSelect" class="swal2-input">
              <option value="" disabled selected style="font-family: 'Segoe UI'; font-weight: 500; font-size: 1em;">Select a sensor</option>
              ${sensorOptions}
            </select>
          </div>
          <div class = 'createalertsection'>
            
            <div class = 'datatypeselectbuttons'>
              <button id="tempButton" class="button-select">Temperatureüå°Ô∏è</button>
              <button id="humButton" class="button-select">Humidityüíß</button>
              <button id="lightButton" class="button-select">Lightüí°</button>
            </div>
          
          </div>
          <div class = 'createalertsection' id = 'conditionalertsection'>
            
            <div class = 'gthanlthan'>
              <button id="lessThanButton" class="button-select"><</button>
              <button id="greaterThanButton" class="button-select">></button>
            </div>

            
           
          </div>
          <div class = 'createalertsection'>
            
            <input type="number" id="thresholdValue" class="swal2-input" placeholder="Enter threshold value">
          </div>
          <div class = 'createalertsection'>
            
            <input type="text" id="phoneNumber" class="swal2-input" placeholder="Enter phone number">
          </div>
          <div class = 'createalertsection'>
            
            <input type="text" id="alertMessage" class="swal2-input" placeholder="Enter alert message">
          </div>
        `,
        focusConfirm: false,
        preConfirm: () => {
          const sensorId = Swal.getPopup().querySelector('#sensorSelect').value;
          const thresholdValue = Swal.getPopup().querySelector('#thresholdValue').value;
          const phoneNumber = Swal.getPopup().querySelector('#phoneNumber').value;
          const alertMessage = Swal.getPopup().querySelector('#alertMessage').value;

          if (!selectedDataType || !selectedCondition) {
            Swal.showValidationMessage(`Please select data type and condition`);
            return false;
          }

          return { sensorId, dataType: selectedDataType, alertCondition: selectedCondition, thresholdValue, phoneNumber, alertMessage };
        },
        showCancelButton: true,
        confirmButtonText: 'Create Alert'
      }).then((result) => {
        if (result.isConfirmed) {
          const alertData = result.value;
          fetch('/create-alert', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(alertData)
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              Swal.fire('Success!', 'Your alert has been created.', 'success')
              .then(() => {
                location.reload();
              });
            } else {
              Swal.fire('Error!', 'There was a problem creating your alert.', 'error');
            }
          });
        }
      });

      // Add event listeners for the data type buttons
      document.getElementById('tempButton').addEventListener('click', function() {
        selectDataType('temperature', 'tempButton');
      });
      document.getElementById('humButton').addEventListener('click', function() {
        selectDataType('humidity', 'humButton');
      });
      document.getElementById('lightButton').addEventListener('click', function() {
        selectDataType('light', 'lightButton');
      });

      // Add event listeners for the condition buttons
      document.getElementById('lessThanButton').addEventListener('click', function() {
        selectCondition('less_than', 'lessThanButton');
      });
      document.getElementById('greaterThanButton').addEventListener('click', function() {
        selectCondition('greater_than', 'greaterThanButton');
      });

      function selectDataType(type, buttonId) {
        selectedDataType = type;
        ['tempButton', 'humButton', 'lightButton'].forEach(id => {
          document.getElementById(id).classList.remove('selected');
        });
        document.getElementById(buttonId).classList.add('selected');
      }

      function selectCondition(condition, buttonId) {
        selectedCondition = condition;
        ['lessThanButton', 'greaterThanButton'].forEach(id => {
          document.getElementById(id).classList.remove('selected');
        });
        document.getElementById(buttonId).classList.add('selected');
      }

    });


    });
    </script>
</body>
</html>
